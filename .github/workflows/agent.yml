name: agent

on:
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  repository-projects: write

jobs:
  setup:
    runs-on: ubuntu-latest
    if: >
      github.repository_owner == 'harpertoken'
      && github.event_name == 'pull_request'
      && github.event.pull_request.merged == true
    outputs:
      manifest_name: ${{ steps.read.outputs.name }}
      manifest_description: ${{ steps.read.outputs.description }}
    steps:
      - uses: actions/checkout@v6

      - id: read
        name: read manifest
        run: |
          NAME=$(grep '^name:' .agent | awk '{print $2}')
          DESC=$(grep '^description:' .agent | cut -d':' -f2- | xargs)
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "description=$DESC" >> $GITHUB_OUTPUT

  health-check:
    needs: setup
    if: >
      github.repository_owner == 'harpertoken'
      && github.event_name == 'pull_request'
      && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: setup environment
        run: |
          sudo apt update
          sudo apt install -y nlohmann-json3-dev cmake build-essential \
            libcurl4-openssl-dev libattr1-dev libssl-dev linux-libc-dev

      - name: configure build
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release 2>&1 | tee cmake_config.log || true

      - name: run diagnostics and generate report
        id: report
        run: |
          echo "Running ${{ needs.setup.outputs.manifest_name }} diagnostics..."
          echo "${{ needs.setup.outputs.manifest_description }}"
          echo "---------------------------------------------"

          # Check if cmake configuration succeeded
          if [ -f "build/CMakeCache.txt" ]; then
            CONFIG_STATUS="Passed"; CONFIG_PERCENT=100
          else
            CONFIG_STATUS="Failed"; CONFIG_PERCENT=40
          fi

          # Build and capture result (ignore CMake config warnings)
          BUILD_LOG=$(cmake --build build --config Release 2>&1 || true)
          # Check for actual compilation/link errors, not CMake config warnings
          if echo "$BUILD_LOG" | grep -qE "error:.*\.(cpp|c|h|cc|cxx):[0-9]+:"; then
            BUILD_STATUS="Failed"; BUILD_PERCENT=40
          elif echo "$BUILD_LOG" | grep -qE "^make.*Error|^make.*error:|collect2: error:"; then
            BUILD_STATUS="Failed"; BUILD_PERCENT=40
          elif echo "$BUILD_LOG" | grep -q "built successfully\|Build completed\|Linking\|Building"; then
            BUILD_STATUS="Passed"; BUILD_PERCENT=100
          else
            BUILD_STATUS="Passed"; BUILD_PERCENT=100
          fi

          # Run tests with better detection
          TEST_LOG=$(ctest --test-dir build --output-on-failure 2>&1 || true)
          FAILED_TESTS=$(echo "$TEST_LOG" | grep -c "  FAILED" || echo "0")
          PASSED_TESTS=$(echo "$TEST_LOG" | grep -c "  Passed" || echo "0")
          if [ "$FAILED_TESTS" -gt 0 ]; then
            TEST_STATUS="Partial"; TEST_PERCENT=60
          elif [ "$PASSED_TESTS" -gt 0 ]; then
            TEST_STATUS="Passed"; TEST_PERCENT=100
          elif echo "$TEST_LOG" | grep -q "100% tests passed"; then
            TEST_STATUS="Passed"; TEST_PERCENT=100
          elif echo "$TEST_LOG" | grep -q "tests failed"; then
            TEST_STATUS="Partial"; TEST_PERCENT=60
          else
            TEST_STATUS="No tests"; TEST_PERCENT=0
          fi

          TODO_COUNT=$(grep -r "TODO\\|FIXME\\|HACK" src/ include/ 2>/dev/null | wc -l || echo "0")
          if [ "$TODO_COUNT" -gt 0 ]; then
            QUALITY_STATUS="$TODO_COUNT issue(s)"; QUALITY_PERCENT=70
          else
            QUALITY_STATUS="Clean"; QUALITY_PERCENT=100
          fi

          if cmake --build build --target preflight > /dev/null 2>&1; then
            PREFLIGHT_STATUS="Passed"; PREFLIGHT_PERCENT=100
          else
            PREFLIGHT_STATUS="Review"; PREFLIGHT_PERCENT=60
          fi

          TOTAL=$((BUILD_PERCENT + TEST_PERCENT + QUALITY_PERCENT + PREFLIGHT_PERCENT))
          AVG=$((TOTAL / 4))
          if [ "$AVG" -ge 90 ]; then OVERALL="Operational"
          elif [ "$AVG" -ge 70 ]; then OVERALL="Degraded"
          else OVERALL="Unstable"; fi

          progress_bar() {
            local percent=$1; local done=$((percent/10)); local remain=$((10-done))
            printf "["; printf "%0.s#" $(seq 1 $done); printf "%0.s." $(seq 1 $remain)
            printf "] %s%%" "$percent"
          }

          {
            echo "## ${{ needs.setup.outputs.manifest_name }}"
            echo ""
            echo "**Build:** $(progress_bar $BUILD_PERCENT) ($BUILD_STATUS)"
            echo "**Tests:** $(progress_bar $TEST_PERCENT) ($TEST_STATUS)"
            echo "**Quality:** $(progress_bar $QUALITY_PERCENT) ($QUALITY_STATUS)"
            echo "**Checks:** $(progress_bar $PREFLIGHT_PERCENT) ($PREFLIGHT_STATUS)"
            echo ""
            echo "**Overall:** $OVERALL (${AVG}%)"
          } | tee report.md

          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: post health report
        uses: actions/github-script@v8
        with:
          script: |
            const report = `${{ steps.report.outputs.report }}`;
            const item = context.payload.issue || context.payload.pull_request;
            if (!item || item.locked) {
              console.log('Skipping comment: item not found or locked');
              return;
            }
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  todo-management:
    if: >
      github.event_name == 'issues' && contains(github.event.issue.body, 'TODO')
      && github.repository_owner == 'harpertoken'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: process todos
        uses: actions/github-script@v8
        with:
          script: |
            const todos = [...context.payload.issue.body.matchAll(/TODO:\s*(.+)/gi)];
            for (const [, title] of todos) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `TODO: ${title.trim()}`,
                body: `From #${context.issue.number}`,
                labels: ['todo']
              });
            }
            if (todos.length) {
              if (!context.payload.issue?.locked) {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `Created ${todos.length} sub-issue${todos.length > 1 ? 's' : ''}.`
                });
              }
            }

  milestone-assignment:
    if: >
      github.event_name == 'pull_request' && github.event.action == 'opened'
      && github.repository_owner == 'harpertoken'
    runs-on: ubuntu-latest
    steps:
      - name: assign milestone
        uses: actions/github-script@v8
        with:
          script: |
            const content = `${context.payload.pull_request.title} ${
              context.payload.pull_request.body || ''}`.toLowerCase();
            const map = {
              'Next Release': ['feature'],
              'Bug Fixes': ['bug', 'fix'],
              'Technical Debt': ['refactor']
            };
            for (const [name, keywords] of Object.entries(map)) {
              if (keywords.some(k => content.includes(k))) {
                const { data } = await github.rest.issues.listMilestones({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                const milestone = data.find(m => m.title === name);
                if (milestone) {
                  await github.rest.issues.update({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    milestone: milestone.number
                  });
                  const item = context.payload.issue || context.payload.pull_request;
                  if (item && !item.locked) {
                    await github.rest.issues.createComment({
                      issue_number: context.issue.number,
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      body: `Milestone: **${name}**`
                    });
                  }
                }
                break;
              }
            }
