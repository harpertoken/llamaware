name: bump version
description: 'Bump version based on PR labels and create release. Supports configurable tag prefix.'

inputs:
  pr-number:
    description: 'Pull request number'
    required: true
  token:
    description: 'GitHub token for API access'
    required: true
  tag-prefix:
    description: 'Prefix for tags and releases'
    required: false
    default: 'v'

runs:
  using: 'composite'
  steps:
    - name: Determine bump type
      id: bump-type
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        PR_NUMBER: ${{ inputs.pr-number }}
      run: |
        PR_TITLE=$(gh pr view "$PR_NUMBER" --json title -q '.title')
        printf "PR Title: %s\n" "${PR_TITLE}"

        if printf "%s" "${PR_TITLE}" | grep -q -E "^(chore: bump version to|chore\[version\] :: bump version to)"; then
          printf "Skipping bump for version bump PR\n"
          printf "bump-type=skip\n" >> $GITHUB_OUTPUT
          exit 0
        fi

        LABELS=$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name')
        printf "Labels: %s\n" "${LABELS}"

        BUMP_COUNT=$(printf "%s" "${LABELS}" | grep -c -E "^(major|minor|patch)$" || true)
        BUMP_COUNT=${BUMP_COUNT:-0}
        if [ "$BUMP_COUNT" -gt 1 ]; then
          printf "Warning: Multiple bump labels found.\n"
        fi

        BUMP_TYPE="patch"
        if printf "%s" "${LABELS}" | grep -qx "major"; then
          BUMP_TYPE="major"
        elif printf "%s" "${LABELS}" | grep -qx "minor"; then
          BUMP_TYPE="minor"
        elif printf "%s" "${LABELS}" | grep -qx "patch"; then
          BUMP_TYPE="patch"
        fi

        printf "bump-type=%s\n" "${BUMP_TYPE}" >> $GITHUB_OUTPUT

    - name: Bump version
      if: steps.bump-type.outputs.bump-type != 'skip'
      shell: bash
      run: |
        chmod +x ./scripts/version.sh
        ./scripts/version.sh ${{ steps.bump-type.outputs.bump-type }}

    - name: Get version
      id: version
      shell: bash
      run: |
        VERSION=$(cat VERSION)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

    - name: Create version bump PR
      if: steps.bump-type.outputs.bump-type != 'skip'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        PR_NUMBER: ${{ inputs.pr-number }}
      run: |
        VERSION=${{ steps.version.outputs.version }}
        TAG_PREFIX=${{ inputs.tag-prefix }}
        BRANCH_NAME="version-bump-${VERSION}"

        EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq 'length')
        if [ "$EXISTING_PR" -gt 0 ]; then
          echo "Version bump PR for $VERSION already exists."
          exit 0
        fi

        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git checkout -B "$BRANCH_NAME"
        git add VERSION CHANGELOG.md
        git commit -m "chore: bump version to ${VERSION}"
        git push --force-with-lease origin "$BRANCH_NAME"

        gh pr create --title "chore: bump version to ${VERSION}" \
          --body "Automated version bump to ${VERSION} after merging PR #${PR_NUMBER}." \
          --base main --head "$BRANCH_NAME"

    - name: Create and push tag
      if: steps.bump-type.outputs.bump-type == 'skip'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        VERSION=${{ steps.version.outputs.version }}
        TAG_PREFIX=${{ inputs.tag-prefix }}

        if git ls-remote --tags --exit-code origin "${TAG_PREFIX}${VERSION}"; then
          echo "Tag ${TAG_PREFIX}${VERSION} already exists."
        else
          git tag "${TAG_PREFIX}${VERSION}"
          git push origin "${TAG_PREFIX}${VERSION}"
        fi

    - name: Create release
      if: steps.bump-type.outputs.bump-type == 'skip'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        PR_NUMBER: ${{ inputs.pr-number }}
      run: |
        VERSION=${{ steps.version.outputs.version }}
        TAG_PREFIX=${{ inputs.tag-prefix }}

        if gh release view "${TAG_PREFIX}${VERSION}" &>/dev/null; then
          echo "Release ${TAG_PREFIX}${VERSION} already exists."
          exit 0
        fi

        gh release create "${TAG_PREFIX}${VERSION}" \
          --title "Release ${VERSION}" \
          --notes "Automated release for version ${VERSION}."
